#!/usr/bin/env ruby

# Usage: emerge-gem [emerge options] gemname

# NOTES:
# Where to put under /usr/local/portage ?
# mv ebuild there.
# ebuild <path to ebuild> digest

require 'rubygems'
require 'emerge-gem'

argv = ARGV.dup

gems = []
emerge_options = []
portage_base_dir = '/usr/local/portage'
portage_path = 'dev-ruby'

collecting_emerge_options = false
while argv.any?
  arg = argv.shift
  case arg
  when '--'
    collecting_emerge_options = true
  when '--portage-base-dir'
    portage_base_dir = arg
  when '--portage-path'
    portage_path = arg
  else
    if collecting_emerge_options
      emerge_options << arg
    else
      gems << arg
    end
  end
end

ebuild_dest ||= "#{portage_base_dir}/#{portage_path}"

package = ARGV.first

ebuilds = {}
while gems.any?
  next_package = gems.shift

  if ! ebuilds[ next_package ]
    puts "Gathering info about #{next_package}..."
    ebuilds[ next_package ] = Ebuild.create_from_spec_lookup( next_package )
  else
    puts "(already know about #{next_package})"
  end

  ebuilds[ next_package ].spec.dependencies.each do |dependency|
    next  if ebuilds[ dependency.name ]
    puts "Need to lookup dependency #{dependency.name}"
    gems.push dependency.name
  end
end

ebuilds.each_pair do |name, ebuild|
  puts "Writing out #{ebuild.filename}"
  ebuild.write
end

